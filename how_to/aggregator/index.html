



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.3, mkdocs-material-2.7.3">
    
    
      
        <title>M3Aggregator - M3 Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.8d40d89b.css">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#setting-up-m3-aggregator" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="M3 Documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                M3 Documentation
              </span>
              <span class="md-header-nav__topic">
                M3Aggregator
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/m3db/m3/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      m3db/m3
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    M3 Documentation
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/m3db/m3/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      m3db/m3
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Overview
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Overview
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../overview/components/" title="Components" class="md-nav__link">
      Components
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../overview/motivation/" title="Motivation" class="md-nav__link">
      Motivation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../overview/media/" title="Media" class="md-nav__link">
      Media
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../overview/roadmap/" title="Roadmap" class="md-nav__link">
      Roadmap
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      M3DB
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        M3DB
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      Architecture
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/engine/" title="Storage Engine" class="md-nav__link">
      Storage Engine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/sharding/" title="Sharding and Replication" class="md-nav__link">
      Sharding and Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/consistencylevels/" title="Consistency Levels" class="md-nav__link">
      Consistency Levels
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/storage/" title="Storage" class="md-nav__link">
      Storage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/commitlogs/" title="Commit Logs" class="md-nav__link">
      Commit Logs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/peer_streaming/" title="Peer Streaming" class="md-nav__link">
      Peer Streaming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/caching/" title="Caching" class="md-nav__link">
      Caching
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      M3 Coordinator
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        M3 Coordinator
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3coordinator/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3coordinator/api/remote/" title="Prometheus Remote Write/Read" class="md-nav__link">
      Prometheus Remote Write/Read
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      M3 Query
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        M3 Query
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Configuration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        Configuration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/config/" title="Query Engine" class="md-nav__link">
      Query Engine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/config/annotated_config/" title="Annotated Config File" class="md-nav__link">
      Annotated Config File
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/api/" title="Query" class="md-nav__link">
      Query
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Architecture
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/architecture/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/architecture/blocks/" title="Blocks" class="md-nav__link">
      Blocks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/architecture/fanout/" title="Query Fanout" class="md-nav__link">
      Query Fanout
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/architecture/functions/" title="Function Processing" class="md-nav__link">
      Function Processing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      How-To's
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        How-To's
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../single_node/" title="M3DB Single Node Deployment" class="md-nav__link">
      M3DB Single Node Deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cluster_hard_way/" title="M3DB Cluster Deployment, Manually" class="md-nav__link">
      M3DB Cluster Deployment, Manually
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kubernetes/" title="M3DB on Kubernetes" class="md-nav__link">
      M3DB on Kubernetes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../query/" title="M3Query" class="md-nav__link">
      M3Query
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        M3Aggregator
      </label>
    
    <a href="./" title="M3Aggregator" class="md-nav__link md-nav__link--active">
      M3Aggregator
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" title="Configuration" class="md-nav__link">
    Configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#topology" title="Topology" class="md-nav__link">
    Topology
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initializing-aggregator-topology" title="Initializing aggregator topology" class="md-nav__link">
    Initializing aggregator topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-m3msg-topic-for-m3aggregator-to-receive-from-m3coordinators-to-aggregate-metrics" title="Initializing m3msg topic for m3aggregator to receive from m3coordinators to aggregate metrics" class="md-nav__link">
    Initializing m3msg topic for m3aggregator to receive from m3coordinators to aggregate metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-m3aggregagtor-consumer-group-to-ingest-topic" title="Add m3aggregagtor consumer group to ingest topic" class="md-nav__link">
    Add m3aggregagtor consumer group to ingest topic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-m3msg-topic-for-m3coordinator-to-receive-from-m3aggregator-to-write-to-m3db" title="Initializing m3msg topic for m3coordinator to receive from m3aggregator to write to M3DB" class="md-nav__link">
    Initializing m3msg topic for m3coordinator to receive from m3aggregator to write to M3DB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-m3coordinator-topology" title="Initializing m3coordinator topology" class="md-nav__link">
    Initializing m3coordinator topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-m3coordinator-consumer-group-to-outbound-topic" title="Add m3coordinator consumer group to outbound topic" class="md-nav__link">
    Add m3coordinator consumer group to outbound topic
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running" title="Running" class="md-nav__link">
    Running
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dedicated-coordinator" title="Dedicated Coordinator" class="md-nav__link">
    Dedicated Coordinator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#m3-aggregator" title="M3 Aggregator" class="md-nav__link">
    M3 Aggregator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" title="Usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../use_as_tsdb/" title="Use M3DB as a general purpose time series database" class="md-nav__link">
      Use M3DB as a general purpose time series database
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Operational Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Operational Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/replication_and_deployment_in_zones/" title="Replication and Deployment in Zones" class="md-nav__link">
      Replication and Deployment in Zones
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/upgrading_m3/" title="Upgrading M3" class="md-nav__link">
      Upgrading M3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/resource_limits/" title="Resource Limits and Preventing Abusive Reads/Writes" class="md-nav__link">
      Resource Limits and Preventing Abusive Reads/Writes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/availability_consistency_durability/" title="Tuning Availability, Consistency, and Durability" class="md-nav__link">
      Tuning Availability, Consistency, and Durability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/placement/" title="Placement/Topology" class="md-nav__link">
      Placement/Topology
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/placement_configuration/" title="Placement/Topology Configuration" class="md-nav__link">
      Placement/Topology Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/namespace_configuration/" title="Namespace Configuration" class="md-nav__link">
      Namespace Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/bootstrapping_crash_recovery/" title="Bootstrapping & Crash Recovery" class="md-nav__link">
      Bootstrapping & Crash Recovery
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/kernel_configuration/" title="Docker & Kernel Configuration" class="md-nav__link">
      Docker & Kernel Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/etcd/" title="etcd" class="md-nav__link">
      etcd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/mapping_rollup/" title="Configuring Mapping & Rollup Rules" class="md-nav__link">
      Configuring Mapping & Rollup Rules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/upgrading_m3/" title="Upgrading M3" class="md-nav__link">
      Upgrading M3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/repairs/" title="Repairs" class="md-nav__link">
      Repairs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operational_guide/replication_between_clusters/" title="Replication Between Clusters" class="md-nav__link">
      Replication Between Clusters
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Integrations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Integrations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../integrations/prometheus/" title="Prometheus" class="md-nav__link">
      Prometheus
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../integrations/graphite/" title="Graphite" class="md-nav__link">
      Graphite
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../integrations/grafana/" title="Grafana" class="md-nav__link">
      Grafana
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../integrations/influxdb/" title="InfluxDB" class="md-nav__link">
      InfluxDB
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../troubleshooting/" title="Troubleshooting" class="md-nav__link">
      Troubleshooting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../faqs/" title="FAQs" class="md-nav__link">
      FAQs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../glossary/" title="Glossary" class="md-nav__link">
      Glossary
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../misc/writing_docs/" title="Tips For Writing Documentation" class="md-nav__link">
      Tips For Writing Documentation
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" title="Configuration" class="md-nav__link">
    Configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#topology" title="Topology" class="md-nav__link">
    Topology
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initializing-aggregator-topology" title="Initializing aggregator topology" class="md-nav__link">
    Initializing aggregator topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-m3msg-topic-for-m3aggregator-to-receive-from-m3coordinators-to-aggregate-metrics" title="Initializing m3msg topic for m3aggregator to receive from m3coordinators to aggregate metrics" class="md-nav__link">
    Initializing m3msg topic for m3aggregator to receive from m3coordinators to aggregate metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-m3aggregagtor-consumer-group-to-ingest-topic" title="Add m3aggregagtor consumer group to ingest topic" class="md-nav__link">
    Add m3aggregagtor consumer group to ingest topic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-m3msg-topic-for-m3coordinator-to-receive-from-m3aggregator-to-write-to-m3db" title="Initializing m3msg topic for m3coordinator to receive from m3aggregator to write to M3DB" class="md-nav__link">
    Initializing m3msg topic for m3coordinator to receive from m3aggregator to write to M3DB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-m3coordinator-topology" title="Initializing m3coordinator topology" class="md-nav__link">
    Initializing m3coordinator topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-m3coordinator-consumer-group-to-outbound-topic" title="Add m3coordinator consumer group to outbound topic" class="md-nav__link">
    Add m3coordinator consumer group to outbound topic
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running" title="Running" class="md-nav__link">
    Running
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dedicated-coordinator" title="Dedicated Coordinator" class="md-nav__link">
    Dedicated Coordinator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#m3-aggregator" title="M3 Aggregator" class="md-nav__link">
    M3 Aggregator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" title="Usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/m3db/m3/edit/master/docs/how_to/aggregator.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="setting-up-m3-aggregator">Setting up M3 Aggregator</h1>
<h2 id="introduction">Introduction</h2>
<p><code>m3aggregator</code> is used to cluster stateful downsampling and rollup of metrics before they are store in M3DB. The M3 Coordinator also performs this role but is not cluster aware. This means metrics will not get aggregated properly if you send metrics in round robin fashion to multiple M3 Coordinators for the same metrics ingestion source (e.g. Prometheus server).</p>
<p>Similar to M3DB, <code>m3aggregator</code> supports clustering and replication by default. This means that metrics are correctly routed to the instance(s) responsible for aggregating each metric and multiple <code>m3aggregator</code> replicas can be configured such that there are no single points of failure for aggregation.</p>
<h2 id="configuration">Configuration</h2>
<p>Before setting up m3aggregator, make sure that you have at least <a href="../single_node/">one M3DB node running</a> and a dedicated m3coordinator setup.</p>
<p>We highly recommend running with at least a replication factor 2 for a <code>m3aggregator</code> deployment. If you run with replication factor 1 then when you restart an aggregator it will temporarily interrupt good the stream of aggregated metrics and there will be some data loss.</p>
<h3 id="topology">Topology</h3>
<h4 id="initializing-aggregator-topology">Initializing aggregator topology</h4>
<p>You can setup a m3aggregator topology by issuing a request to your coordinator (be sure to use your own hostnames, number of shards and replication factor):
<div class="highlight"><pre><span></span>curl -vvvsSf -H <span class="s2">&quot;Cluster-Environment-Name: namespace/m3db-cluster-name&quot;</span> -X POST http://m3dbnode-with-embedded-coordinator:7201/api/v1/services/m3aggregator/placement/init -d <span class="s1">&#39;{</span>
<span class="s1">    &quot;num_shards&quot;: 64,</span>
<span class="s1">    &quot;replication_factor&quot;: 2,</span>
<span class="s1">    &quot;instances&quot;: [</span>
<span class="s1">        {</span>
<span class="s1">            &quot;id&quot;: &quot;m3aggregator01:6000&quot;,</span>
<span class="s1">            &quot;isolation_group&quot;: &quot;availability-zone-a&quot;,</span>
<span class="s1">            &quot;zone&quot;: &quot;embedded&quot;,</span>
<span class="s1">            &quot;weight&quot;: 100,</span>
<span class="s1">            &quot;endpoint&quot;: &quot;m3aggregator01:6000&quot;,</span>
<span class="s1">            &quot;hostname&quot;: &quot;m3aggregator01&quot;,</span>
<span class="s1">            &quot;port&quot;: 6000</span>
<span class="s1">        },</span>
<span class="s1">        {</span>
<span class="s1">            &quot;id&quot;: &quot;m3aggregator02:6000&quot;,</span>
<span class="s1">            &quot;isolation_group&quot;: &quot;availability-zone-b&quot;,</span>
<span class="s1">            &quot;zone&quot;: &quot;embedded&quot;,</span>
<span class="s1">            &quot;weight&quot;: 100,</span>
<span class="s1">            &quot;endpoint&quot;: &quot;m3aggregator02:6000&quot;,</span>
<span class="s1">            &quot;hostname&quot;: &quot;m3aggregator02&quot;,</span>
<span class="s1">            &quot;port&quot;: 6000</span>
<span class="s1">        }</span>
<span class="s1">    ]</span>
<span class="s1">}&#39;</span>
</pre></div></p>
<h4 id="initializing-m3msg-topic-for-m3aggregator-to-receive-from-m3coordinators-to-aggregate-metrics">Initializing m3msg topic for m3aggregator to receive from m3coordinators to aggregate metrics</h4>
<p>Now we must setup a topic for the <code>m3aggregator</code> to receive unaggregated metrics from <code>m3coordinator</code> instances:</p>
<div class="highlight"><pre><span></span>curl -vvvsSf -H <span class="s2">&quot;Cluster-Environment-Name: namespace/m3db-cluster-name&quot;</span> -H <span class="s2">&quot;Topic-Name: aggregator_ingest&quot;</span> -X POST http://m3dbnode-with-embedded-coordinator:7201/api/v1/topic/init -d <span class="s1">&#39;{</span>
<span class="s1">    &quot;numberOfShards&quot;: 64</span>
<span class="s1">}&#39;</span>
</pre></div>

<h4 id="add-m3aggregagtor-consumer-group-to-ingest-topic">Add m3aggregagtor consumer group to ingest topic</h4>
<p>Add the <code>m3aggregator</code> placement to receive traffic from the topic (make sure to set message TTL to match your desired maximum in memory retry message buffer):
<div class="highlight"><pre><span></span>curl -vvvsSf -H <span class="s2">&quot;Cluster-Environment-Name: namespace/m3db-cluster-name&quot;</span> -H <span class="s2">&quot;Topic-Name: aggregator_ingest&quot;</span> -X POST http://m3dbnode-with-embedded-coordinator:7201/api/v1/topic -d <span class="s1">&#39;{</span>
<span class="s1">  &quot;consumerService&quot;: {</span>
<span class="s1">    &quot;serviceId&quot;: {</span>
<span class="s1">      &quot;name&quot;: &quot;m3aggregator&quot;,</span>
<span class="s1">      &quot;environment&quot;: &quot;namespace/m3db-cluster-name&quot;,</span>
<span class="s1">      &quot;zone&quot;: &quot;embedded&quot;</span>
<span class="s1">    },</span>
<span class="s1">    &quot;consumptionType&quot;: &quot;REPLICATED&quot;,</span>
<span class="s1">    &quot;messageTtlNanos&quot;: &quot;300000000000&quot;</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</pre></div></p>
<p><strong>Note:</strong> 300000000000 nanoseconds is a TTL of 5 minutes for messages to rebuffer for retry.</p>
<h4 id="initializing-m3msg-topic-for-m3coordinator-to-receive-from-m3aggregator-to-write-to-m3db">Initializing m3msg topic for m3coordinator to receive from m3aggregator to write to M3DB</h4>
<p>Now we must setup a topic for the <code>m3coordinator</code> to receive unaggregated metrics from <code>m3aggregator</code> instances to write to M3DB:
<div class="highlight"><pre><span></span>curl -vvvsSf -H <span class="s2">&quot;Cluster-Environment-Name: namespace/m3db-cluster-name&quot;</span> -H <span class="s2">&quot;Topic-Name: aggregated_metrics&quot;</span> -X POST http://m3dbnode-with-embedded-coordinator:7201/api/v1/topic/init -d <span class="s1">&#39;{</span>
<span class="s1">    &quot;numberOfShards&quot;: 64</span>
<span class="s1">}&#39;</span>
</pre></div></p>
<h4 id="initializing-m3coordinator-topology">Initializing m3coordinator topology</h4>
<p>Then <code>m3coordinator</code> instances need to be configured to receive traffic for this topic (note ingest at port 7507 must match the configured port for your <code>m3coordinator</code> ingest server, see config at bottom of this guide):
<div class="highlight"><pre><span></span>curl -vvvsSf -H <span class="s2">&quot;Cluster-Environment-Name: namespace/m3db-cluster-name&quot;</span> -X POST http://m3dbnode-with-embedded-coordinator:7201/api/v1/services/m3coordinator/placement/init -d <span class="s1">&#39;{</span>
<span class="s1">    &quot;instances&quot;: [</span>
<span class="s1">        {</span>
<span class="s1">            &quot;id&quot;: &quot;m3coordinator01&quot;,</span>
<span class="s1">            &quot;zone&quot;: &quot;embedded&quot;,</span>
<span class="s1">            &quot;endpoint&quot;: &quot;m3coordinator01:7507&quot;,</span>
<span class="s1">            &quot;hostname&quot;: &quot;m3coordinator01&quot;,</span>
<span class="s1">            &quot;port&quot;: 7507</span>
<span class="s1">        }</span>
<span class="s1">    ]</span>
<span class="s1">}&#39;</span>
</pre></div></p>
<p><strong>Note:</strong> When you add or remove <code>m3coordinator</code> instances they must be added to this placement.</p>
<h4 id="add-m3coordinator-consumer-group-to-outbound-topic">Add m3coordinator consumer group to outbound topic</h4>
<p>Add the <code>m3coordinator</code> placement to receive traffic from the topic (make sure to set message TTL to match your desired maximum in memory retry message buffer):
<div class="highlight"><pre><span></span>curl -vvvsSf -H <span class="s2">&quot;Cluster-Environment-Name: namespace/m3db-cluster-name&quot;</span> -H <span class="s2">&quot;Topic-Name: aggregated_metrics&quot;</span> -X POST http://m3dbnode-with-embedded-coordinator:7201/api/v1/topic -d <span class="s1">&#39;{</span>
<span class="s1">  &quot;consumerService&quot;: {</span>
<span class="s1">    &quot;serviceId&quot;: {</span>
<span class="s1">      &quot;name&quot;: &quot;m3coordinator&quot;,</span>
<span class="s1">      &quot;environment&quot;: &quot;namespace/m3db-cluster-name&quot;,</span>
<span class="s1">      &quot;zone&quot;: &quot;embedded&quot;</span>
<span class="s1">    },</span>
<span class="s1">    &quot;consumptionType&quot;: &quot;SHARED&quot;,</span>
<span class="s1">    &quot;messageTtlNanos&quot;: &quot;300000000000&quot;</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</pre></div></p>
<p><strong>Note:</strong> 300000000000 nanoseconds is a TTL of 5 minutes for messages to rebuffer for retry.</p>
<h3 id="running">Running</h3>
<h4 id="dedicated-coordinator">Dedicated Coordinator</h4>
<p>Metrics will still arrive at the <code>m3coordinator</code>, they simply need to be forwarded to an <code>m3aggregator</code>. The <code>m3coordinator</code> then also needs to receive metrics that have been aggregated from the <code>m3aggregator</code> and store them in M3DB, so running an ingestion server should be configured.</p>
<p>Here is the config you should add to your <code>m3coordinator</code>:
<div class="highlight"><pre><span></span><span class="c1"># This is for sending metrics to the remote m3aggregators</span>
<span class="nt">downsample</span><span class="p">:</span>
  <span class="nt">remoteAggregator</span><span class="p">:</span>
    <span class="nt">client</span><span class="p">:</span>
      <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">m3msg</span>
      <span class="nt">m3msg</span><span class="p">:</span>
        <span class="nt">producer</span><span class="p">:</span>
          <span class="nt">writer</span><span class="p">:</span>
            <span class="nt">topicName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aggregator_ingest</span>
            <span class="nt">topicServiceOverride</span><span class="p">:</span>
              <span class="nt">zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">embedded</span>
              <span class="nt">environment</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">namespace/m3db-cluster-name</span>
            <span class="nt">placement</span><span class="p">:</span>
              <span class="nt">isStaged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
            <span class="nt">placementServiceOverride</span><span class="p">:</span>
              <span class="nt">namespaces</span><span class="p">:</span>
                <span class="nt">placement</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/placement</span>
            <span class="nt">connection</span><span class="p">:</span>
              <span class="nt">numConnections</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
            <span class="nt">messagePool</span><span class="p">:</span>
              <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">16384</span>
              <span class="nt">watermark</span><span class="p">:</span>
                <span class="nt">low</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.2</span>
                <span class="nt">high</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>

<span class="c1"># This is for configuring the ingestion server that will receive metrics from the m3aggregators on port 7507</span>
<span class="nt">ingest</span><span class="p">:</span>
  <span class="nt">ingester</span><span class="p">:</span>
    <span class="nt">workerPoolSize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10000</span>
    <span class="nt">opPool</span><span class="p">:</span>
      <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10000</span>
    <span class="nt">retry</span><span class="p">:</span>
      <span class="nt">maxRetries</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
      <span class="nt">jitter</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">logSampleRate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.01</span>
  <span class="nt">m3msg</span><span class="p">:</span>
    <span class="nt">server</span><span class="p">:</span>
      <span class="nt">listenAddress</span><span class="p">:</span> <span class="s">&quot;0.0.0.0:7507&quot;</span>
      <span class="nt">retry</span><span class="p">:</span>
        <span class="nt">maxBackoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
        <span class="nt">jitter</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div></p>
<h4 id="m3-aggregator">M3 Aggregator</h4>
<p>You can run <code>m3aggregator</code> by either building and running the binary yourself:</p>
<div class="highlight"><pre><span></span>make m3aggregator
./bin/m3aggregator -f ./src/aggregator/config/m3aggregator.yml
</pre></div>

<p>Or you can run it with Docker using the Docker file located at <code>docker/m3aggregator/Dockerfile</code> or the publicly provided image <code>quay.io/m3db/m3aggregator:latest</code>.</p>
<p>You can use a config like so, making note of the topics used such as <code>aggregator_ingest</code> and <code>aggregated_metrics</code> and the corresponding environment <code>namespace/m3db-cluster-name</code>:</p>
<div class="highlight"><pre><span></span><span class="nt">logging</span><span class="p">:</span>
  <span class="nt">level</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">info</span>

<span class="nt">metrics</span><span class="p">:</span>
  <span class="nt">scope</span><span class="p">:</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">m3aggregator</span>
  <span class="nt">prometheus</span><span class="p">:</span>
    <span class="nt">onError</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">none</span>
    <span class="nt">handlerPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/metrics</span>
    <span class="nt">listenAddress</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0.0.0:6002</span>
    <span class="nt">timerType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">histogram</span>
  <span class="nt">sanitization</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus</span>
  <span class="nt">samplingRate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0</span>
  <span class="nt">extended</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">none</span>

<span class="nt">m3msg</span><span class="p">:</span>
  <span class="nt">server</span><span class="p">:</span>
    <span class="nt">listenAddress</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0.0.0:6000</span>
    <span class="nt">retry</span><span class="p">:</span>
      <span class="nt">maxBackoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
      <span class="nt">jitter</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">consumer</span><span class="p">:</span>
    <span class="nt">messagePool</span><span class="p">:</span>
      <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">16384</span>
      <span class="nt">watermark</span><span class="p">:</span>
        <span class="nt">low</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.2</span>
        <span class="nt">high</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>

<span class="nt">http</span><span class="p">:</span>
  <span class="nt">listenAddress</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0.0.0:6001</span>
  <span class="nt">readTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">60s</span>
  <span class="nt">writeTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">60s</span>

<span class="nt">kvClient</span><span class="p">:</span>
  <span class="nt">etcd</span><span class="p">:</span>
    <span class="nt">env</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">namespace/m3db-cluster-name</span>
    <span class="nt">zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">embedded</span>
    <span class="nt">service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">m3aggregator</span>
    <span class="nt">cacheDir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/var/lib/m3kv</span>
    <span class="nt">etcdClusters</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">embedded</span>
        <span class="nt">endpoints</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">dbnode01:2379</span>

<span class="nt">runtimeOptions</span><span class="p">:</span>
  <span class="nt">kvConfig</span><span class="p">:</span>
    <span class="nt">environment</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">namespace/m3db-cluster-name</span>
    <span class="nt">zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">embedded</span>
  <span class="nt">writeValuesPerMetricLimitPerSecondKey</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">write-values-per-metric-limit-per-second</span>
  <span class="nt">writeValuesPerMetricLimitPerSecond</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="nt">writeNewMetricLimitClusterPerSecondKey</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">write-new-metric-limit-cluster-per-second</span>
  <span class="nt">writeNewMetricLimitClusterPerSecond</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="nt">writeNewMetricNoLimitWarmupDuration</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>

<span class="nt">aggregator</span><span class="p">:</span>
  <span class="nt">hostID</span><span class="p">:</span>
    <span class="nt">resolver</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">environment</span>
    <span class="nt">envVarName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">M3AGGREGATOR_HOST_ID</span>
  <span class="nt">instanceID</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">host_id</span>
  <span class="nt">verboseErrors</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">metricPrefix</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
  <span class="nt">counterPrefix</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
  <span class="nt">timerPrefix</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
  <span class="nt">gaugePrefix</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
  <span class="nt">aggregationTypes</span><span class="p">:</span>
    <span class="nt">counterTransformFnType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">empty</span>
    <span class="nt">timerTransformFnType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">suffix</span>
    <span class="nt">gaugeTransformFnType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">empty</span>
    <span class="nt">aggregationTypesPool</span><span class="p">:</span>
      <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1024</span>
    <span class="nt">quantilesPool</span><span class="p">:</span>
      <span class="nt">buckets</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">count</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">256</span>
          <span class="nt">capacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
        <span class="p p-Indicator">-</span> <span class="nt">count</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">128</span>
          <span class="nt">capacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8</span>
  <span class="nt">stream</span><span class="p">:</span>
    <span class="nt">eps</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.001</span>
    <span class="nt">capacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">32</span>
    <span class="nt">streamPool</span><span class="p">:</span>
      <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4096</span>
    <span class="nt">samplePool</span><span class="p">:</span>
      <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4096</span>
    <span class="nt">floatsPool</span><span class="p">:</span>
      <span class="nt">buckets</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">count</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4096</span>
          <span class="nt">capacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">16</span>
        <span class="p p-Indicator">-</span> <span class="nt">count</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2048</span>
          <span class="nt">capacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">32</span>
        <span class="p p-Indicator">-</span> <span class="nt">count</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1024</span>
          <span class="nt">capacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">64</span>
  <span class="nt">client</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">m3msg</span>
    <span class="nt">m3msg</span><span class="p">:</span>
      <span class="nt">producer</span><span class="p">:</span>
        <span class="nt">writer</span><span class="p">:</span>
          <span class="nt">topicName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aggregator_ingest</span>
          <span class="nt">topicServiceOverride</span><span class="p">:</span>
            <span class="nt">zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">embedded</span>
            <span class="nt">environment</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">namespace/m3db-cluster-name</span>
          <span class="nt">placement</span><span class="p">:</span>
            <span class="nt">isStaged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">placementServiceOverride</span><span class="p">:</span>
            <span class="nt">namespaces</span><span class="p">:</span>
              <span class="nt">placement</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/placement</span>
          <span class="nt">messagePool</span><span class="p">:</span>
            <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">16384</span>
            <span class="nt">watermark</span><span class="p">:</span>
              <span class="nt">low</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.2</span>
              <span class="nt">high</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>
  <span class="nt">placementManager</span><span class="p">:</span>
    <span class="nt">kvConfig</span><span class="p">:</span>
      <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/placement</span>
      <span class="nt">environment</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">namespace/m3db-cluster-name</span>
      <span class="nt">zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">embedded</span>
    <span class="nt">placementWatcher</span><span class="p">:</span>
      <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">m3aggregator</span>
      <span class="nt">initWatchTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
  <span class="nt">hashType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">murmur32</span>
  <span class="nt">bufferDurationBeforeShardCutover</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10m</span>
  <span class="nt">bufferDurationAfterShardCutoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10m</span>
  <span class="nt">bufferDurationForFutureTimedMetric</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10m</span> <span class="c1"># Allow test to write into future.</span>
  <span class="nt">resignTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1m</span>
  <span class="nt">flushTimesManager</span><span class="p">:</span>
    <span class="nt">kvConfig</span><span class="p">:</span>
      <span class="nt">environment</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">namespace/m3db-cluster-name</span>
      <span class="nt">zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">embedded</span>
    <span class="nt">flushTimesKeyFmt</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">shardset/%d/flush</span>
    <span class="nt">flushTimesPersistRetrier</span><span class="p">:</span>
      <span class="nt">initialBackoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100ms</span>
      <span class="nt">backoffFactor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0</span>
      <span class="nt">maxBackoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2s</span>
      <span class="nt">maxRetries</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="nt">electionManager</span><span class="p">:</span>
    <span class="nt">election</span><span class="p">:</span>
      <span class="nt">leaderTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
      <span class="nt">resignTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
      <span class="nt">ttlSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
    <span class="nt">serviceID</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">m3aggregator</span>
      <span class="nt">environment</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">namespace/m3db-cluster-name</span>
      <span class="nt">zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">embedded</span>
    <span class="nt">electionKeyFmt</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">shardset/%d/lock</span>
    <span class="nt">campaignRetrier</span><span class="p">:</span>
      <span class="nt">initialBackoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100ms</span>
      <span class="nt">backoffFactor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0</span>
      <span class="nt">maxBackoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2s</span>
      <span class="nt">forever</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">jitter</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">changeRetrier</span><span class="p">:</span>
      <span class="nt">initialBackoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100ms</span>
      <span class="nt">backoffFactor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0</span>
      <span class="nt">maxBackoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5s</span>
      <span class="nt">forever</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">jitter</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">resignRetrier</span><span class="p">:</span>
      <span class="nt">initialBackoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100ms</span>
      <span class="nt">backoffFactor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0</span>
      <span class="nt">maxBackoff</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5s</span>
      <span class="nt">forever</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">jitter</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">campaignStateCheckInterval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1s</span>
    <span class="nt">shardCutoffCheckOffset</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30s</span>
  <span class="nt">flushManager</span><span class="p">:</span>
    <span class="nt">checkEvery</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1s</span>
    <span class="nt">jitterEnabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">maxJitters</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">flushInterval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5s</span>
        <span class="nt">maxJitterPercent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0</span>
      <span class="p p-Indicator">-</span> <span class="nt">flushInterval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
        <span class="nt">maxJitterPercent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>
      <span class="p p-Indicator">-</span> <span class="nt">flushInterval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1m</span>
        <span class="nt">maxJitterPercent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>
      <span class="p p-Indicator">-</span> <span class="nt">flushInterval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10m</span>
        <span class="nt">maxJitterPercent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>
      <span class="p p-Indicator">-</span> <span class="nt">flushInterval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1h</span>
        <span class="nt">maxJitterPercent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.25</span>
    <span class="nt">numWorkersPerCPU</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>
    <span class="nt">flushTimesPersistEvery</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
    <span class="nt">maxBufferSize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5m</span>
    <span class="nt">forcedFlushWindowSize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
  <span class="nt">flush</span><span class="p">:</span>
    <span class="nt">handlers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">dynamicBackend</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">m3msg</span>
          <span class="nt">hashType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">murmur32</span>
          <span class="nt">producer</span><span class="p">:</span>
            <span class="nt">writer</span><span class="p">:</span>
              <span class="nt">topicName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aggregated_metrics</span>
              <span class="nt">topicServiceOverride</span><span class="p">:</span>
                <span class="nt">zone</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">embedded</span>
                <span class="nt">environment</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">namespace/m3db-cluster-name</span>
              <span class="nt">messagePool</span><span class="p">:</span>
                <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">16384</span>
                <span class="nt">watermark</span><span class="p">:</span>
                  <span class="nt">low</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.2</span>
                  <span class="nt">high</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>
  <span class="nt">passthrough</span><span class="p">:</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">forwarding</span><span class="p">:</span>
    <span class="nt">maxConstDelay</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5m</span> <span class="c1"># Need to add some buffer window, since timed metrics by default are delayed by 1min.</span>
  <span class="nt">entryTTL</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1h</span>
  <span class="nt">entryCheckInterval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10m</span>
  <span class="nt">maxTimerBatchSizePerWrite</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">140</span>
  <span class="nt">defaultStoragePolicies</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
  <span class="nt">maxNumCachedSourceSets</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
  <span class="nt">discardNaNAggregatedValues</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">entryPool</span><span class="p">:</span>
    <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4096</span>
  <span class="nt">counterElemPool</span><span class="p">:</span>
    <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4096</span>
  <span class="nt">timerElemPool</span><span class="p">:</span>
    <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4096</span>
  <span class="nt">gaugeElemPool</span><span class="p">:</span>
    <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4096</span>
</pre></div>

<h2 id="usage">Usage</h2>
<p>Send metrics as usual to your <code>m3coordinator</code> instances in round robin fashion (or any other load balancing strategy), the metrics will be forwarded to the <code>m3aggregator</code> instances, then once aggregated they will be returned to the <code>m3coordinator</code> instances to write to M3DB.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../query/" title="M3Query" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                M3Query
              </span>
            </div>
          </a>
        
        
          <a href="../use_as_tsdb/" title="Use M3DB as a general purpose time series database" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Use M3DB as a general purpose time series database
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b438e6c5.js"></script>
      
      <script>app.initialize({version:"0.17.3",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>